%    Copyright (C) 2014 Imperial College London.

%    This file is part of Firedrake-Fluids.
%
%    Firedrake-Fluids is free software: you can redistribute it and/or modify
%    it under the terms of the GNU General Public License as published by
%    the Free Software Foundation, either version 3 of the License, or
%    (at your option) any later version.
%
%    Firedrake-Fluids is distributed in the hope that it will be useful,
%    but WITHOUT ANY WARRANTY; without even the implied warranty of
%    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%    GNU General Public License for more details.
%
%    You should have received a copy of the GNU General Public License
%    along with Firedrake-Fluids.  If not, see <http://www.gnu.org/licenses/>.

\documentclass[a4paper,11pt]{report}
\usepackage[top=3cm, bottom=3cm, left=3cm, right=3cm]{geometry}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\usepackage{tikz}
\usepackage{amsmath, amssymb}

\title{Firedrake-Fluids User Manual}
\author{Imperial College London}

\begin{document}

\maketitle
\tableofcontents

\setlength{\parskip}{0.3cm}
\setlength{\parindent}{0cm}

\chapter{Introduction}
\section{Overview}
Firedrake-Fluids is a collection of numerical models for the study of fluid dynamical systems. It uses the Firedrake framework (\texttt{http://firedrakeproject.org/}) to automate the solution of the governing equations written in their weak form using the Unified Form Language (UFL).

\section{Setup and installation}
Firedrake-Fluids comprises a collection of Python files containing the implementation of the different models; a set of schema files used to define the different options a simulation configuration file can take; and a set of test cases to help ensure the correctness of the models.


\chapter{Shallow water model}
The shallow water model solves the non-linear, non-rotational shallow water equations which describe the dynamics of a free surface and a depth-averaged velocity field. For modelling purposes, the free surface is split up into a mean component $H$ (i.e. the hydrostatic depth to the seabed) and a perturbation component $h$ (see Figure \ref{fig:shallow_water_setup}).

\begin{figure}
   \centering
   \begin{tikzpicture}
      % Draw the main box     
      \draw[style={thick}] (0, 0) -- (0, 5) -- (10, 5) -- (10, 0) -- cycle;
         
      % Draw the sine curves
      \draw[x=0.5cm,y=1cm, thick, blue] 
        (0,4) sin (1,4.5) cos (2,4) sin (3,3.5) cos (4,4) sin (5,4.5) cos (6,4) sin (7,3.5) cos (8,4)
              sin (9,4.5) cos (10,4) sin (11,3.5) cos (12,4) sin (13,4.5) cos (14,4) sin (15,3.5) cos (16,4) sin (17,4.5) cos (18,4) sin (19,3.5) cos (20,4);

      \draw[style={dashed, ultra thick}] (0, 4) -- (10, 4);

      \draw[arrows=<->, style={ultra thick}] (2.5, 0) -- (2.5, 4);
      \draw (2.7, 2) node{\footnotesize $H$};
      \draw[arrows=<->, style={ultra thick}] (2.5, 4) -- (2.5, 4.5);
      \draw (2.7, 4.25) node{\footnotesize $h$};
      
      \end{tikzpicture}
      \caption{Single-layer shallow water set-up.}
      \label{fig:shallow_water_setup}
   \end{figure}


\section{Model equations}
The shallow water equation set comprises a momentum equation and a continuity equation, each of which are defined below.

\subsection{Momentum equation}
The momentum equation is solved in non-conservative form such that
\begin{equation}
   \frac{\partial \mathbf{u}}{\partial t} + \mathbf{u}\cdot\nabla\mathbf{u} = -g\nabla h + \nabla\cdot\mathbb{T} - C_D\frac{||\mathbf{u}||\mathbf{u}}{(H + h)},
\end{equation}
where $g$ is the acceleration due to gravity, $\mathbf{u}$ is the velocity, and $C_D$ is the non-dimensional drag coefficient. The stress tensor $\mathbb{T}$ is given by 
\begin{equation}
   \mathbb{T} = \nu\left(\nabla\mathbf{u} + \nabla\mathbf{u}^{\mathrm{T}}\right) - \frac{2}{3}\nu\nabla\cdot\mathbf{u},
\end{equation}
where $\nu$ is the isotropic kinematic viscosity.

\subsection{Continuity equation}
The continuity equation is given by
\begin{equation}
   \frac{\partial h}{\partial t} + \nabla\cdot\left(\left(H + h\right)\mathbf{u}\right) = 0.
\end{equation}

\section{Configuration}
\subsection{Simulation name}

\subsection{Geometry}

\subsection{Function spaces}

\subsection{Input/output (I/O)}

\subsection{Timestepping}

\subsection{Physical parameters}

\subsection{System: Core fields}
The model requires three fields to be set up under the \texttt{/system/core\_fields} section of the setup file. These are the key fields used in shallow water simulations, and are named
\begin{itemize}
   \item \textit{Velocity} (a prognostic field, corresponding to $\mathbf{u}$).
   \item \textit{FreeSurfacePerturbation} (a prognostic field, corresponding to $h$)
   \item \textit{FreeSurfaceMean} (a prescribed field, corresponding to $H$)
\end{itemize}
It is here that the initial and boundary conditions for the fields can be specified.

\subsubsection{Boundary conditions}
\begin{itemize}
   \item \textit{Dirichlet}: Strong Dirichlet boundary conditions can be enforced for both the FreeSurfacePerturbation and Velocity fields by selecting the \texttt{dirichlet} type.
   \item \textit{No-normal flow}: Imposing a no-normal flow condition for velocity can currently only be done weakly by integrating the continuity equation by parts and selecting the \texttt{no\_normal\_flow} boundary condition type in the configuration options.
   \item \textit{Flather}: A \cite{Flather_1963} open boundary condition can be imposed weakly by integrating the continuity equation by parts and selecting the \texttt{flather} boundary condition type in the configuration options. This boundary condition enforces:
   
   
   . Any difference between the exterior values and the simulated values along the boundary is allowed out of the domain in such a way that minimises spurious reflections.
\end{itemize}

\subsection{System: Equations}

\subsubsection{Spatial discretisation}
The spatial discretisation (continuous or discontinuous Galerkin) currently depends on the continuity of the function spaces in use, rather than on the choices made in this option. However, if \texttt{continuous\_galerkin} is selected, there are stabilisation-related sub-options available to stabilise the advection term when using CG. See Chapter \ref{chap:stabilisation} for more information on the stabilisation schemes available.

\subsubsection{Drag}
To include the quadratic drag term in the momentum equation, the \texttt{drag\_term} option must be enabled under \texttt{/system/equations/momentum\_equation/} and the non-dimensional drag coefficient $C_D$ should be specified.

 

\section{Current limitations}
\begin{itemize}
   \item When using a discontinuous Galerkin method, the form of the stress tensor is currently restricted to:
   \begin{equation}
      \mathbb{T} = \nu\nabla\mathbf{u}.
   \end{equation}
   \item When using a discontinuous Galerkin discretisation, the interior penalty method is the only method available for determining the value of $\nabla\mathbf{u}$ at the discontinuous interior element boundaries. Similarly, only a simple upwinding method can be used to determine $\mathbf{u}$ at along interior element boundaries.
\end{itemize}

\chapter{Stabilisation methods}\label{chap:stabilisation}

\section{Streamline upwind}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%% Turbulence parameterisation %%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Turbulence parameterisation}
This chapter describes the turbulence models that are available in Firedrake-Fluids.

\section{Large Eddy Simulation (LES)}

\subsection{Smagorinsky model}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%% Diagnostic fields %%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Diagnostic fields}
Some stand-alone functions are available in the \texttt{diagnostics.py} file for computing 

\section{Courant number}
The Courant number diagnostic computes the field defined by
\begin{equation}
   \frac{||\mathbf{u}||\Delta t}{\Delta x},
\end{equation}
where $\Delta t$ is the time-step size and $\Delta x$ is the element size (more specifically, it is twice the element's circumradius).

\section{Divergence}
This diagnostic field computes the divergence
\begin{equation}
   \nabla\cdot\mathbf{u},
\end{equation}
of a vector field $\mathbf{u}$.


\end{document}
